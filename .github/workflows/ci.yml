name: CI

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'bin/**'
      - 'licenses/**'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'bin/**'
      - 'licenses/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 代码格式检查
  format-check:
    name: Code Format Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-15
        sudo ln -sf /usr/bin/clang-format-15 /usr/bin/clang-format
    
    - name: Check code formatting
      run: |
        find duilib -name "*.cpp" -o -name "*.h" | head -20 | xargs clang-format --dry-run --Werror
      continue-on-error: true

  # 静态分析检查
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: format-check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install clang-tidy
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy-15
        sudo ln -sf /usr/bin/clang-tidy-15 /usr/bin/clang-tidy
    
    - name: Run clang-tidy
      run: |
        # 仅检查核心文件（演示目的）
        if [ -f .clang-tidy ]; then
          echo "Found .clang-tidy configuration"
          clang-tidy --version
        else
          echo "No .clang-tidy configuration found"
        fi
      continue-on-error: true

  # Windows 构建检查
  build-windows:
    name: Build (Windows)
    runs-on: windows-latest
    needs: format-check
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
      
    - name: Check project structure
      shell: pwsh
      run: |
        Write-Host "Checking project structure..."
        if (Test-Path "build/examples.sln") {
          Write-Host "Found Visual Studio solution"
        } else {
          Write-Host "Solution file not found - external dependencies (Skia, SDL3) required"
        }
        
        if (Test-Path "duilib/CMakeLists.txt") {
          Write-Host "Found CMake configuration"
        }
    
    - name: CMake Generate (Header-only check)
      shell: pwsh
      run: |
        # 仅验证 CMake 配置语法（不实际构建，因为需要 Skia/SDL3）
        Write-Host "CMake configuration validation..."
        Write-Host "Note: Full build requires external dependencies:"
        Write-Host "  - Skia (../skia)"
        Write-Host "  - SDL3 (../SDL3) - optional on Windows"
        Write-Host "  - CEF (for browser support)"

  # Linux 构建检查  
  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest
    needs: format-check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build clang
    
    - name: Check CMake configuration
      run: |
        echo "Checking CMakeLists.txt..."
        head -50 duilib/CMakeLists.txt
        echo ""
        echo "Note: Full build requires external dependencies:"
        echo "  - Skia (../skia)"
        echo "  - SDL3 (../SDL3)"

  # macOS 构建检查
  build-macos:
    name: Build (macOS)
    runs-on: macos-latest
    needs: format-check
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        brew install cmake ninja
    
    - name: Check CMake configuration
      run: |
        echo "Checking CMakeLists.txt..."
        head -50 duilib/CMakeLists.txt
        echo ""
        echo "Note: Full build requires external dependencies:"
        echo "  - Skia (../skia)"
        echo "  - SDL3 (../SDL3)"
        echo "  - CEF (for browser support)"

  # 单元测试（实际编译并运行）
  unit-tests:
    name: Unit Tests (Windows)
    runs-on: windows-latest
    needs: format-check

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Configure CMake
      run: cmake -B build -S tests -DCMAKE_BUILD_TYPE=Release

    - name: Build tests
      run: cmake --build build --config Release

    - name: List tests
      run: ctest --test-dir build -C Release -N

    - name: Run tests
      run: |
        ctest --test-dir build -C Release --output-on-failure

  coverage:
    name: Coverage (Linux)
    runs-on: ubuntu-latest
    needs: format-check

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build gcc g++ gcovr

    - name: Run coverage
      run: |
        bash build/coverage.sh

    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: build/coverage/report
        if-no-files-found: error

    - name: Publish coverage summary
      if: always()
      run: |
        if [ -f build/coverage/report/coverage.txt ]; then
          echo "## Coverage Summary" >> "$GITHUB_STEP_SUMMARY"
          echo '```text' >> "$GITHUB_STEP_SUMMARY"
          cat build/coverage/report/coverage.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
        fi

  # 文档检查
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check documentation
      run: |
        echo "Checking documentation files..."
        ls -la docs/
        echo ""
        echo "Documentation status:"
        echo "  - README.md: $(test -f README.md && echo 'OK' || echo 'MISSING')"
        echo "  - LICENSE: $(test -f LICENSE && echo 'OK' || echo 'MISSING')"
        echo "  - docs/: $(test -d docs && echo 'OK' || echo 'MISSING')"
        echo "  - examples/: $(test -d examples && echo 'OK' || echo 'MISSING')"

  # 汇总状态
  status-summary:
    name: CI Status Summary
    runs-on: ubuntu-latest
    needs: [format-check, static-analysis, build-windows, build-linux, build-macos, unit-tests, coverage, docs-check]
    if: always()
    
    steps:
    - name: Report status
      run: |
        echo "=== CI Build Summary ==="
        echo "Format Check: ${{ needs.format-check.result }}"
        echo "Static Analysis: ${{ needs.static-analysis.result }}"
        echo "Windows Build: ${{ needs.build-windows.result }}"
        echo "Linux Build: ${{ needs.build-linux.result }}"
        echo "macOS Build: ${{ needs.build-macos.result }}"
        echo "Unit Tests: ${{ needs.unit-tests.result }}"
        echo "Coverage: ${{ needs.coverage.result }}"
        echo "Documentation: ${{ needs.docs-check.result }}"
        echo ""
        echo "Note: Full compilation requires external dependencies (Skia, SDL3, CEF)"
        echo "which are not included in this repository."
